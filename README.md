# Шаблон web-приложения для rootles docker

Это шаблон проекта для небольшого приложения nginx+php+mariadb. Проект предназначен для развёртывания в rootless docker как в локльном окружении разработчика, так и на продуктовом сервере.

Полезен, если мы хотим развернуть несколько мельких, но требующих изоляции, проектов на VPS стоимостью как бутылка "Нарзана" в месяц.

Особенности шаблона:

 - исходники и данные приложения разделены (`app/` и `volumes/app`);
 - исходники проброшены в контейнер php и nginx как readonly;
 - логирование php и nginx идёт в файлы, при этом есть скрипт ротации логов;
 - готов скрипт бэкапа/восстановления;
 - не требуется docker build на проде, используются базовые образы php, mariadb и nginx с докерхаба;
 - шаблон легко доработать под свой проект.

## Требования к локальному окружению разаработчика и боевомк серверу

 - Linux;
 - docker в [rootless mode](https://docs.docker.com/engine/security/rootless/);
 - rsync+ssh дял деполя;
 - make для красоты;
 - docker compose как утилита или плагин;
 - внешний реверсивный прокси (nginx, traefik или подобный) на боевом сервере;

Внешний реверсивный прокси нужен чтобы слушать 80 и 443 порт.

**Обычный docker (не rootless mode) не получится использовать с этим шаблоном - у большинства скриптов будут проблемы с правами**.

## Команды проекта

`make dev-setup` - первичная подготовка проекта к работе (env + sofiles)

`make env` - создать env-файл

`make up` - поднять проект

`make down` - положить проект

`make restart` - полный перезапуск проекта (down + up)

`make reload` - сигнал USR1 для nginx и php-fpm (переоткрывает логи)

`make sh` - занустить шелл в контейнере php

`make mysql` - занустить шелл в контейнере mysql

`make sofiles` - пересобрать расширения php (заполнить `volumes/usr`)

## Команды runtime

`runtime/backup.sh` - сделать бэкап БД или файлов (`backup.sh database > db.sql.gz` и `backup.sh files > vol.sql.gz`)

`runtime/restore.sh` - восстановить бэкап БД или файлов (`restore.sh database db.sql.gz` и `restore.sh files vol.sql.gz`)

`runtime/logrotate.sh` - ротация логов в папке `volume/logs`, можно ставить в cron

`runtime/fullbackup_and_rotate.sh` - создание полного бэкапа в папку `backups` + ротация бэкапов, можно ставить в cron

## Деплой

`site_upsync.sh` - копирует проект из текущей папки на удялённый сервер (конфигурация деплоя в `site_sync_cfg`)

## Как начать проект

### Подготовка окружения

Ставим rootless docker по инструкции на локальном окружнии. Создаём пользователя под проект на сервере, ставим в домашний каталог этого пользователя rootles docker. Не забываем поставить docker compose.

На боевом сервере нужно не забыть поставить сервис docker в автозапуск:

```
systemctl --user enable docker
```

И разрешить старт сервисов пользователя до логина:

```
sudo loginctl enable-linger PROJECT_USER
```

Не забывам пробисать `DOCKER_HOST` rootless docker-а в `~/.profile` (нужно для cron-скриптов) И в `~/.bashrc` (нужно для нашего удобства). Выгляит обычно как-то так: `export DOCKER_HOST=unix:////run/user/1001/docker.sock`

Чтобы runtime-скрипты нормально работали в cron нужно в crontab прописать домашний каталог: `HOME=/home/PROJECT_USER` (`crontab -e` и далее по ману).

### Подготовка проекта

Берём этот шаблон шаблон (`git clone ...`). Выполняем `make dev-setup`. Должен появится файл `.env` и кучка библиотек в `volumes/usr`.

Теперь настраиваем `.env`, `site_sync_cfg` и, при необходимости `docker-compose.yml`, под своё приложение.

Внимание к параметрам:

`COMPOSE=` - если compose установлен как плагин, то `COMPOSE=docker compose`, если как отдельная утилита, то `COMPOSE=docke-compose`

`EMAIL_...` - эти парметры нужны только если мы планируем рассылать почту скриптом `bin/sendmail.sh`, это подходит для совсем простых приложений, которые используют php-шную функцию **mail()** напрямую.

Теперь всё готово. `make up` должна поднять локальный проект. C праметрами по умолчанию, то на `http://127.0.0.1:8321/` будет phpinfo.

В папке `webconf/` два конфига nginx.

`webconf/nginx_docker.conf` - этот конфиг контейнера nginx.

`webconf/example.com.conf` - этот пример конфига виртуалхоста для внешнего реверсивного прокси.
